<!DOCTYPE html><html lang="en"><head><title>core/remote</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="core/remote"><meta name="groc-project-path" content="src/core/remote.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/core/remote.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="remote">Remote</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Connection to a remote Couch Database.</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="store-api">store API</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>object loading / updating / deleting</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>find(type, id)</li>
<li>findAll(type )</li>
<li>add(type, object)</li>
<li>save(type, id, object)</li>
<li>update(new_properties )</li>
<li>updateAll( type, new_properties)</li>
<li>remove(type, id)</li>
<li>removeAll(type)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>custom requests</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>request(view, params)</li>
<li>get(view, params)</li>
<li>post(view, params)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>synchronization</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>connect()</li>
<li>disconnect()</li>
<li>pull()</li>
<li>push()</li>
<li>sync()</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>event binding</p></div></div><div class="code"><div class="wrapper"><span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>on(event, callback)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="c1">#</span>
<span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Remote</span> <span class="k">extends</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Store</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="properties">properties</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>name  </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the name of the Remote is the name of the
CouchDB database and is also used to prefix 
triggered events</p></div></div><div class="code"><div class="wrapper">  <span class="nv">name : </span><span class="kc">undefined</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sync  </p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if set to true, updates will be continuously pulled
and pushed. Alternatively, <code>sync</code> can be set to
<code>pull: true</code> or <code>push: true</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">connected : </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prefix</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prefix for docs in a CouchDB database, e.g. all docs
in public user stores are prefixed by '$public/'</p></div></div><div class="code"><div class="wrapper">  <span class="nv">prefix : </span><span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="constructor-">Constructor </h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sets name (think: namespace) and some other options</p></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor : </span><span class="nf">(@hoodie, options = {}) -&gt;</span>
    
    <span class="c1">#</span>
    <span class="vi">@name      = </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span>      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span>  
    <span class="vi">@prefix    = </span><span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span><span class="o">?</span>
    <span class="vi">@connected = </span><span class="nx">options</span><span class="p">.</span><span class="nx">connected</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">connected</span><span class="o">?</span>
    <span class="vi">@baseUrl   = </span><span class="nx">options</span><span class="p">.</span><span class="nx">baseUrl</span>   <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">baseUrl</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>in order to differentiate whether an object from remote should trigger a 'new'
or an 'update' event, we store a hash of known objects</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@_knownObjects = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>NOTE: 
Due to a bug in Chrome (I guess), the loader won't disappear
when the page is loaded, when we start a long poll request
before the page loaded.
On the other side, we do not want to wait for to the page
and all its assets to be loaded before we start loading
our data. 
A good way to fix it would be a special <code>bootstrap</code> method,
that would load all objects with a normal GET /<em>all</em>docs request,
after that it would start with the GET /_changes requests,
starting with the current seq number of the database.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@connect</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@isConnected</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="request">request</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>wrapper for hoodie.request, with some store specific defaults
and a prefixed path</p></div></div><div class="code"><div class="wrapper">  <span class="nv">request : </span><span class="nf">(type, path, options = {}) -&gt;</span>
    <span class="nv">path = </span><span class="s">&quot;/</span><span class="si">#{</span><span class="nb">encodeURIComponent</span> <span class="nx">@name</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">@name</span>
    <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@baseUrl</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">@baseUrl</span>

    <span class="nx">options</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">or=</span> <span class="s">&#39;application/json&#39;</span>
    <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;POST&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;PUT&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">dataType</span>    <span class="o">or=</span> <span class="s">&#39;json&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">processData</span> <span class="o">or=</span> <span class="kc">false</span>
      <span class="nv">options.data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="get">get</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>send a GET request to the named view</p></div></div><div class="code"><div class="wrapper">  <span class="nv">get : </span><span class="nf">(view_name, params) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;.get() not yet implemented&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="post">post</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sends a POST request to the specified updated_function</p></div></div><div class="code"><div class="wrapper">  <span class="nv">post : </span><span class="nf">(update_function_name, params) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;.post() not yet implemented&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="store-operations-overides">Store Operations overides</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="find">find</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>find one object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">find : </span><span class="nf">(type, id) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">path = </span><span class="nx">@prefix</span> <span class="o">+</span> <span class="nx">path</span> <span class="k">if</span> <span class="nx">@prefix</span>
    <span class="nv">path = </span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="nx">path</span>
    <span class="nx">@request</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_parseFromRemote</span><span class="p">)</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="findall">findAll</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>find all objects, can be filetered by a type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">findAll : </span><span class="nf">(type) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">path = </span><span class="s">&quot;/_all_docs?include_docs=true&quot;</span>
    <span class="k">switch</span> <span class="kc">true</span>
      <span class="k">when</span> <span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@prefix</span> <span class="o">isnt</span> <span class="s">&#39;&#39;</span>
        <span class="nv">startkey = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@prefix</span><span class="si">}#{</span><span class="nx">type</span><span class="si">}</span><span class="s">/&quot;</span>
      <span class="k">when</span> <span class="nx">type</span><span class="o">?</span>
        <span class="nv">startkey = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">/&quot;</span>
      <span class="k">when</span> <span class="nx">@prefix</span> <span class="o">isnt</span> <span class="s">&#39;&#39;</span>
        <span class="nv">startkey = </span><span class="nx">@prefix</span>
      <span class="k">else</span>
        <span class="nv">startkey = </span><span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="nx">startkey</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure that only objects starting with
<code>startkey</code> will be returned</p></div></div><div class="code"><div class="wrapper">      <span class="nv">endkey = </span><span class="nx">startkey</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/.$/</span><span class="p">,</span> <span class="nf">(char) -&gt;</span>
        <span class="nv">charCode = </span><span class="nx">char</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span> <span class="nx">charCode</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&amp;startkey=\&quot;</span><span class="si">#{</span><span class="nb">encodeURIComponent</span> <span class="nx">startkey</span><span class="si">}</span><span class="s">\&quot;&amp;endkey=\&quot;</span><span class="si">#{</span><span class="nb">encodeURIComponent</span> <span class="nx">endkey</span><span class="si">}</span><span class="s">\&quot;&quot;</span>

    <span class="nx">@request</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_mapDocsFromFindAll</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_parseAllFromRemote</span><span class="p">)</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="save">save</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>save a new object. If it existed before, all properties
will be overwritten </p></div></div><div class="code"><div class="wrapper">  <span class="nv">save : </span><span class="nf">(type, id, object) -&gt;</span>
    <span class="nv">defer = </span><span class="k">super</span>
    <span class="k">return</span> <span class="nx">defer</span> <span class="k">if</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">)</span>

    <span class="nv">id = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">uuid</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">id</span> 
    <span class="nv">object = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span>
      <span class="nv">type : </span><span class="nx">type</span>
      <span class="nv">id   : </span><span class="nx">id</span>
    <span class="p">},</span> <span class="nx">object</span>

    <span class="nv">object = </span><span class="nx">@_parseForRemote</span> <span class="nx">object</span>
    <span class="nv">path   = </span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_id</span>

    <span class="nx">@request</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nv">data: </span><span class="nx">object</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="remove">remove</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove one object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">remove : </span><span class="nf">(type, id) -&gt;</span>
    <span class="nx">@update</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nv">_deleted: </span><span class="kc">true</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="removeall">removeAll</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove all objects, can be filtered by type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">removeAll : </span><span class="nf">(type) -&gt;</span>
    <span class="nx">@updateAll</span> <span class="nx">type</span><span class="p">,</span> <span class="nv">_deleted: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="synchronization">synchronization</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="connect">Connect</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start syncing</p></div></div><div class="code"><div class="wrapper">  <span class="nv">connect : </span><span class="nf">(options) =&gt;</span>
    <span class="vi">@connected = </span><span class="kc">true</span>
    <span class="nx">@pull</span><span class="p">()</span>
  
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="disconnect">Disconnect</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stop syncing changes from remote store</p></div></div><div class="code"><div class="wrapper">  <span class="nv">disconnect : </span><span class="o">=&gt;</span>
    <span class="vi">@connected = </span><span class="kc">false</span>
    
    <span class="nx">@_pullRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
    <span class="nx">@_pushRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
  
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="isconnected">isConnected</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">isConnected : </span><span class="nf">-&gt;</span>
    <span class="nx">@connected</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="getsincenr">getSinceNr</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns the sequence number from wich to start to find changes in pull</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">getSinceNr : </span><span class="nf">-&gt;</span>
    <span class="nx">@_since</span> <span class="o">or</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="setsincenr">setSinceNr</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sets the sequence number from wich to start to find changes in pull</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">setSinceNr : </span><span class="nf">(seq) -&gt;</span>
    <span class="vi">@_since = </span><span class="nx">seq</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="pull-changes">pull changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>a.k.a. make a GET request to CouchDB's <code>_changes</code> feed.</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">pull : </span><span class="o">=&gt;</span>
    <span class="vi">@_pullRequest = </span><span class="nx">@request</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">@_pullUrl</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@isConnected</span><span class="p">()</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span> <span class="nx">@_pullRequestTimeout</span>
      <span class="vi">@_pullRequestTimeout = </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@_restartPullRequest</span><span class="p">,</span> <span class="mi">25000</span> <span class="c1"># 25 sec</span>
    
    <span class="nx">@_pullRequest</span><span class="p">.</span><span class="nx">then</span> <span class="nx">@_handlePullSuccess</span><span class="p">,</span> <span class="nx">@_handlePullError</span>
    
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="push-changes">push changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push objects to remote store using the <code>_bulk_docs</code> API.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">push : </span><span class="nf">(objects) =&gt;</span>
    
    <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">resolveWith</span><span class="p">([])</span> <span class="k">unless</span> <span class="nx">objects</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
      
    <span class="nv">objectsForRemote = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">object</span> <span class="k">in</span> <span class="nx">objects</span>
      <span class="nx">@_addRevisionTo</span> <span class="nx">object</span>
      <span class="nv">object = </span><span class="nx">@_parseForRemote</span> <span class="nx">object</span> 
      <span class="nx">objectsForRemote</span><span class="p">.</span><span class="nx">push</span> <span class="nx">object</span>
    
    <span class="vi">@_pushRequest = </span><span class="nx">@request</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&quot;/_bulk_docs&quot;</span><span class="p">,</span>
      <span class="nv">data :</span>
        <span class="nv">docs      : </span><span class="nx">objectsForRemote</span>
        <span class="nv">new_edits : </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="sync-changes">sync changes</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>push objects, then pull updates.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">sync : </span><span class="nf">(objects) =&gt;</span>
    <span class="nx">@push</span><span class="p">(</span><span class="nx">objects</span><span class="p">).</span><span class="nx">pipe</span> <span class="nx">@pull</span>

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="events">Events</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.on</code></p></div></div><div class="code"><div class="wrapper">  <span class="kc">on</span>  <span class="o">:</span> <span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">on</span>  <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="nv">one : </span><span class="nf">(event, cb) -&gt;</span> 
    <span class="nv">event = </span><span class="nx">event</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s">&quot;$1</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:$2&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">one</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>namespaced alias for <code>hoodie.trigger</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">trigger : </span><span class="nf">(event, parameters...) -&gt;</span> 
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">...</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>valid CouchDB doc attributes starting with an underscore</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_validSpecialAttributes : </span><span class="p">[</span>
    <span class="s">&#39;_id&#39;</span><span class="p">,</span> <span class="s">&#39;_rev&#39;</span><span class="p">,</span> <span class="s">&#39;_deleted&#39;</span><span class="p">,</span> <span class="s">&#39;_revisions&#39;</span><span class="p">,</span> <span class="s">&#39;_attachments&#39;</span>
  <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="parse-for-remote">Parse for remote</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>parse object for remote storage. All properties starting with an 
<code>underscore</code> do not get synchronized despite the special properties
<code>_id</code>, <code>_rev</code> and <code>_deleted</code> (see above)</p>

<p>Also <code>id</code> gets replaced with <code>_id</code> which consists of type &amp; id</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_parseForRemote : </span><span class="nf">(object) -&gt;</span>
    <span class="nv">properties = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">object</span>
  
    <span class="k">for</span> <span class="nx">attr</span> <span class="k">of</span> <span class="nx">properties</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="o">~</span><span class="nx">@_validSpecialAttributes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
      <span class="k">continue</span> <span class="k">unless</span> <span class="sr">/^_/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">attr</span>
      <span class="k">delete</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
   </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>prepare CouchDB id</p></div></div><div class="code"><div class="wrapper">    <span class="nv">properties._id = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">properties</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">properties</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="nx">@prefix</span>
      <span class="nv">properties._id = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@prefix</span><span class="si">}#{</span><span class="nx">properties</span><span class="p">.</span><span class="nx">_id</span><span class="si">}</span><span class="s">&quot;</span>
    
    <span class="k">delete</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">id</span>

    <span class="k">return</span> <span class="nx">properties</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-parsefromremote">_parseFromRemote</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>normalize objects coming from remote</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>renames <code>_id</code> attribute to <code>id</code> and removes the type from the id,
e.g. <code>type/123</code> -> <code>123</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">_parseFromRemote : </span><span class="nf">(object) =&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle id and type</p></div></div><div class="code"><div class="wrapper">    <span class="nv">id = </span><span class="nx">object</span><span class="p">.</span><span class="nx">_id</span> <span class="o">or</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_id</span>
    <span class="nv">id = </span><span class="nx">id</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="o">+</span><span class="nx">@prefix</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@prefix</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>turn doc/123 into type = doc &amp; id = 123</p></div></div><div class="code"><div class="wrapper">    <span class="p">[</span><span class="nx">ignore</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([^\/]+)\/(.*)/</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>NOTE:
we don't use a simple id.split(/\//) here, as in some cases
IDs might contain "/", too</p></div></div><div class="code"><div class="wrapper">    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle timestameps</p></div></div><div class="code"><div class="wrapper">    <span class="nv">object.createdAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">object</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span> <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">createdAt</span>
    <span class="nv">object.updatedAt = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span> <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle rev</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">rev</span>
      <span class="nv">object._rev = </span><span class="nx">object</span><span class="p">.</span><span class="nx">rev</span>
      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">rev</span>
    
    <span class="k">return</span> <span class="nx">object</span>
  
  <span class="nv">_parseAllFromRemote : </span><span class="nf">(objects) =&gt;</span>
    <span class="nx">@_parseFromRemote</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="k">for</span> <span class="nx">object</span> <span class="k">in</span> <span class="nx">objects</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="-addrevisionto">_addRevisionTo</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extends passed object with a _rev property</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_addRevisionTo : </span><span class="nf">(attributes) -&gt;</span>

    <span class="k">try</span> <span class="p">[</span><span class="nx">currentRevNr</span><span class="p">,</span> <span class="nx">currentRevId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">_rev</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/-/</span>
    <span class="nv">currentRevNr = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">currentRevNr</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>

    <span class="nv">newRevisionId         = </span><span class="nx">@_generateNewRevisionId</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>local changes are not meant to be replicated outside of the
users database, therefore the <code>-local</code> suffix.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">_$local</span>
      <span class="nx">newRevisionId</span> <span class="o">+=</span> <span class="s">&quot;-local&quot;</span>

    <span class="nv">attributes._rev       = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">currentRevNr</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s">-</span><span class="si">#{</span><span class="nx">newRevisionId</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">attributes._revisions = </span>
      <span class="nv">start : </span><span class="mi">1</span>
      <span class="nv">ids   : </span><span class="p">[</span><span class="nx">newRevisionId</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">currentRevId</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_revisions</span><span class="p">.</span><span class="nx">start</span> <span class="o">+=</span> <span class="nx">currentRevNr</span>
      <span class="nx">attributes</span><span class="p">.</span><span class="nx">_revisions</span><span class="p">.</span><span class="nx">ids</span><span class="p">.</span><span class="nx">push</span> <span class="nx">currentRevId</span>

    

  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="generate-new-revision-id">generate new revision id</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">_generateNewRevisionId: </span> <span class="nf">-&gt;</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">uuid</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="map-docs-from-findall">map docs from findAll</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_mapDocsFromFindAll: </span><span class="nf">(response) =&gt;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">doc</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-url">pull url</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Depending on whether remote is connected, return a longpoll URL or not</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_pullUrl : </span><span class="nf">-&gt;</span>
    <span class="nv">since = </span><span class="nx">@getSinceNr</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@isConnected</span><span class="p">()</span> <span class="c1"># make a long poll request</span>
      <span class="s">&quot;/_changes?include_docs=true&amp;since=</span><span class="si">#{</span><span class="nx">since</span><span class="si">}</span><span class="s">&amp;heartbeat=10000&amp;feed=longpoll&quot;</span>
    <span class="k">else</span>
      <span class="s">&quot;/_changes?include_docs=true&amp;since=</span><span class="si">#{</span><span class="nx">since</span><span class="si">}</span><span class="s">&quot;</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>request gets restarted automaticcally 
when aborted (see @_handlePullError)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_restartPullRequest : </span><span class="o">=&gt;</span> <span class="nx">@_pullRequest</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-success-handler">pull success handler</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle incoming changes, then restart the pull if connected</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_handlePullSuccess : </span><span class="nf">(response) =&gt;</span>
    <span class="nx">@setSinceNr</span> <span class="nx">response</span><span class="p">.</span><span class="nx">last_seq</span>
    <span class="nx">@_handlePullResults</span> <span class="nx">response</span><span class="p">.</span><span class="nx">results</span>
    
    <span class="nx">@pull</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@isConnected</span><span class="p">()</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="pull-error-handler">pull error handler</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when there is a change, trigger event, 
then check for another change</p></div></div><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_handlePullError : </span><span class="nf">(xhr, error, resp) =&gt;</span>
    
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@isConnected</span><span class="p">()</span>

    <span class="k">switch</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Session is invalid. User is still login, but needs to reauthenticate
before sync can be continued</p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">401</span>
        <span class="nx">@trigger</span> <span class="s">&#39;error:unauthenticated&#39;</span><span class="p">,</span> <span class="nx">error</span>
        <span class="nx">@disconnect</span><span class="p">()</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>the 404 comes, when the requested DB has been removed
or does not exist yet.</p>

<p>BUT: it might also happen that the background workers did
     not create a pending database yet. Therefore,
     we try it again in 3 seconds</p></div></div><div class="code"><div class="wrapper">      <span class="c1">#</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: review / rethink that.</p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">404</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Please server, don't give us these. At least not persistently </p></div></div><div class="code"><div class="wrapper">      <span class="k">when</span> <span class="mi">500</span>
        <span class="nx">@trigger</span> <span class="s">&#39;error:server&#39;</span><span class="p">,</span> <span class="nx">error</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span>
        <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">checkConnection</span><span class="p">()</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>usually a 0, which stands for timeout or server not reachable.</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nx">@isConnected</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">is</span> <span class="s">&#39;abort&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>manual abort after 25sec. restart pulling changes directly when connected</p></div></div><div class="code"><div class="wrapper">          <span class="nx">@pull</span><span class="p">()</span>
        <span class="k">else</span>    
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>oops. This might be caused by an unreachable server.
Or the server canceled it for what ever reason, e.g.
heroku kills the request after ~30s.
we'll try again after a 3s timeout</p></div></div><div class="code"><div class="wrapper">          <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@pull</span><span class="p">,</span> <span class="mi">3000</span>

          <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">checkConnection</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="handle-changes-from-remote">handle changes from remote</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="c1">#</span>
  <span class="nv">_handlePullResults : </span><span class="nf">(changes) =&gt;</span>
    <span class="k">for</span> <span class="p">{</span><span class="nx">doc</span><span class="p">}</span> <span class="k">in</span> <span class="nx">changes</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">@prefix</span> <span class="o">and</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@prefix</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>

      <span class="nv">object = </span><span class="nx">@_parseFromRemote</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_deleted</span>
        <span class="k">continue</span> <span class="k">unless</span> <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>

        <span class="nv">event = </span><span class="s">&#39;remove&#39;</span>
        <span class="k">delete</span> <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>

      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
          <span class="nv">event = </span><span class="s">&#39;update&#39;</span>
        <span class="k">else</span>
          <span class="nv">event = </span><span class="s">&#39;add&#39;</span>
          <span class="nx">@_knownObjects</span><span class="p">[</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

      <span class="nx">@trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>                             <span class="nx">object</span>
      <span class="nx">@trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>              <span class="nx">object</span>
      <span class="nx">@trigger</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">event</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">object</span>      
      <span class="nx">@trigger</span> <span class="s">&quot;change&quot;</span><span class="p">,</span>                               <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span>
      <span class="nx">@trigger</span> <span class="s">&quot;change:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>                <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span>
      <span class="nx">@trigger</span> <span class="s">&quot;change:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>   <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span>



<span class="k">class</span> <span class="nx">ConnectionError</span> <span class="k">extends</span> <span class="nb">Error</span>
  <span class="nv">name: </span><span class="s">&quot;ConnectionError&quot;</span>

  <span class="nv">constructor : </span><span class="nf">(@message, @data) -&gt;</span> <span class="k">super</span></div></div></div></div></body></html>